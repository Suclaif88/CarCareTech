{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <link rel="stylesheet" href="{% static 'resources/css/admin.css' %}">
    <link rel="icon" type='image/png' href="{% static 'resources/img/favicon.png' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11">
    <link rel="stylesheet" href="{% static 'resources/css/factura.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>CarCareTech-Admin - Nueva Factura</title>
</head>
<body>

    {% include 'ADMIN/sidebar.html' %}

    <div class="content-wrapper">
        <div class="center-content">
            <h2>Nueva Factura</h2>
            <form id="form-datos-principales" method="post">
                {% csrf_token %}
                
                <label for="id_fecha">Fecha:</label>
                <input type="datetime-local" id="id_fecha" name="fecha" required readonly>
                <br><br>

                <label for="id_placa">Placa del Vehículo:</label>
                <select id="id_placa" name="placa" class="select2" required>
                    <option value="" selected disabled>Seleccione una placa</option>
                    {% for vehiculo in vehiculos %}
                        <option value="{{ vehiculo.placa }}">{{ vehiculo.placa }} - {{ vehiculo.documento }}</option>
                    {% endfor %}
                </select>
                <br><br>

                <label for="id_id_metodo_pago">Método de Pago:</label>
                <select id="id_id_metodo_pago" name="id_metodo_pago" class="select2" required>
                    <option value="" selected disabled>Seleccione un método de pago</option>
                    {% for metodo_pago in metodos_pago %}
                        <option value="{{ metodo_pago.id_metodo_pago }}">{{ metodo_pago.tipo }}</option>
                    {% endfor %}
                </select>
                <br><br>

                <label for="id_nit">NIT de la Empresa:</label>
                <select id="id_nit" name="nit" required disabled>
                {% for empresa in empresas %}
                    <option value="{{ empresa.nit }}" {% if forloop.first %} selected {% endif %}>{{ empresa.nit }} - {{ empresa.nombre }}</option>
                {% endfor %}
                </select>

                <button type="button" id="guardar-datos" class="btn-primary btn-submit"><i class="fas fa-save"></i> Guardar Datos Provisionales</button>
            </form>

            <div id="cuadros-datos-guardados" style="display: none;">
                <div id="id-factura-guardado" class="dato-guardado"></div>
                <div id="fecha-guardada" class="dato-guardado"></div>
                <div id="placa-guardada" class="dato-guardado"></div>
                <div id="metodo-pago-guardado" class="dato-guardado"></div>
                <div id="nit-empresa-guardado" class="dato-guardado"></div>
            </div>


        <div class="containerP" id="formularios" style="display: none;">


            <div class="form1">
                <form id="form-productos">
                    <h3>Productos</h3>
                    <div class="form-group">
                        <label for="id_producto">Productos:</label>
                        <select id="id_producto" name="id_producto" class="form-control" onchange="actualizarPrecio()">
                            <option value="" disabled selected>Selecciona un producto</option>
                            {% for producto in productos %}
                                <option value="{{ producto.id }}" data-precio="{{ producto.precio }}">{{ producto.nombre }}</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" id="id_producto_oculto" name="id_producto_oculto">
                    </div>                                                                                             
                    <div class="form-group">
                        <label for="Precio">Precio:</label>
                        <input type="text" id="Precio" name="Precio" class="form-control" readonly>
                    </div>                  
                    <div class="form-group">
                        <label for="cantidad">Cantidad:</label>
                        <input type="number" id="cantidad" name="cantidad" class="form-control">
                    </div>
                    <button type="button" class="btn-primary btn-submit" onclick="agregarProducto()"><i class="fas fa-save"></i> Agregar</button>
                </form>
            </div>
            
            <div class="form2">
                <form id="form-servicios">
                    <h3>Servicios</h3>
                    <div class="form-group">
                        <label for="id_servicio">Servicio:</label>
                        <select id="id_servicio" name="servicio" class="form-control" required>
                            <option value="" disabled selected>Seleccionar Servicio</option>
                            {% for servicio in servicios %}
                                <option value="{{ servicio.id_servicios }}">{{ servicio.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_precio">Precio:</label>
                        <input type="number" id="id_precio" name="precio" class="form-control" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="id_documento_mecanico">Documento Mecánico:</label>
                        <select id="id_documento_mecanico" name="documento_mecanico" class="form-control" required>
                            <option value="" disabled selected>Seleccionar Documento Mecánico</option>
                            {% for usuario in usuarios %}
                                <option value="{{ usuario.Documento }}">{{ usuario.Documento }} - {{ usuario.Nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn-primary btn-submit" onclick="agregarServicio()"><i class="fas fa-save"></i> Agregar</button>
                </form>
            </div>            
        </div>




    <div class="Tablas-de-selecciones" id="tablas-selecciones" style="display: none;">

        <div class="t1">
            <table id="tabla-productos" class="table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody id="tbody-productos">
                    <!-- Aquí se añadirán las filas dinámicamente -->
                </tbody>
            </table>
        </div>

        <div class="t2">
            <table id="tabla-servicios" class="table">
                <thead>
                    <tr>
                        <th>Servicio</th>
                        <th>Precio</th>
                        <th>Documento Mecanico</th>
                    </tr>
                </thead>
                <tbody id="tbody-servicios">
                    <!-- Aquí se añadirán las filas dinámicamente -->
                </tbody>
            </table>
        </div>

    </div>




        </div>
    </div>

    <script>
        function agregarProducto() {
            var productoId = document.getElementById('id_producto_oculto').value;
            var selectorProducto = document.getElementById('id_producto');
            var productoNombre = selectorProducto.options[selectorProducto.selectedIndex].text;
            var precio = document.getElementById('Precio').value;
            var cantidad = document.getElementById('cantidad').value;
            
            console.log('Producto ID:', productoId);
            console.log('Producto Nombre:', productoNombre);
            console.log('Precio:', precio);
            console.log('Cantidad:', cantidad);
            
            if (productoId && cantidad) {
                var fila = `<tr>
                                <td>${productoNombre}</td>
                                <td>${precio}</td>
                                <td>${cantidad}</td>
                            </tr>`;
                document.getElementById('tbody-productos').insertAdjacentHTML('beforeend', fila);
                
                document.getElementById('id_producto').value = '';
                document.getElementById('id_producto_oculto').value = '';
                document.getElementById('Precio').value = '';
                document.getElementById('cantidad').value = '';
            } else {
                alert('Por favor selecciona un producto y especifica la cantidad.');
            }
        }
        
        
        function agregarServicio() {
            var servicioId = document.getElementById('id_servicio').value;
            var servicioNombre = document.getElementById('id_servicio').options[document.getElementById('id_servicio').selectedIndex].text;
            var precio = document.getElementById('id_precio').value;
            var documentoMecanico = document.getElementById('id_documento_mecanico').value;
    
            if (servicioId && documentoMecanico) {
                var fila = `<tr>
                                <td>${servicioNombre}</td>
                                <td>${precio}</td>
                                <td>${documentoMecanico}</td>
                            </tr>`;
                document.getElementById('tbody-servicios').insertAdjacentHTML('beforeend', fila);
                
                document.getElementById('id_servicio').value = '';
                document.getElementById('id_precio').value = '';
                document.getElementById('id_documento_mecanico').value = '';
            } else {
                alert('Por favor selecciona un servicio y especifica el documento mecánico.');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            var now = moment().tz('America/Bogota').format('YYYY-MM-DDTHH:mm');
            document.getElementById('id_fecha').value = now;
        
            document.getElementById('guardar-datos').addEventListener('click', function() {
                Swal.fire({
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 1000
                });
        
                var fecha = document.getElementById('id_fecha').value;
                var placa = document.getElementById('id_placa').value;
                var metodoPago = document.getElementById('id_id_metodo_pago').value;
                var nitEmpresa = document.getElementById('id_nit').value;
        
                var datos = {
                    idFactura: {{ proximo_id_factura }},
                    fecha: fecha,
                    placa: placa,
                    metodoPago: metodoPago,
                    nitEmpresa: nitEmpresa
                };
        
                localStorage.setItem('datosFactura', JSON.stringify(datos));
        
                document.getElementById('cuadros-datos-guardados').style.display = 'block';
                document.getElementById('id-factura-guardado').innerText = 'ID de Factura: ' + datos.idFactura;
                document.getElementById('fecha-guardada').innerText = 'Fecha: ' + fecha;
                document.getElementById('placa-guardada').innerText = 'Placa del Vehículo: ' + placa;
                document.getElementById('metodo-pago-guardado').innerText = 'Método de Pago: ' + metodoPago;
                document.getElementById('nit-empresa-guardado').innerText = 'NIT de la Empresa: ' + nitEmpresa;
        
                document.getElementById('form-datos-principales').style.display = 'none';
                
                document.getElementById('formularios').style.display = 'grid';
                document.getElementById('tablas-selecciones').style.display = 'grid';
                
            });
        
            document.getElementById('form-segundo-paso').addEventListener('submit', function(event) {
                event.preventDefault();
        
                var datosGuardados = localStorage.getItem('datosFactura');
                if (datosGuardados) {
                    console.log('Datos guardados en localStorage:', JSON.parse(datosGuardados));
                }
            });
        });

        function actualizarPrecio() {
            var selectorProducto = document.getElementById('id_producto');
            var precioSeleccionado = selectorProducto.options[selectorProducto.selectedIndex].getAttribute('data-precio');
            var idProductoSeleccionado = selectorProducto.value;
        
            document.getElementById('Precio').value = precioSeleccionado;
            document.getElementById('id_producto_oculto').value = idProductoSeleccionado; // Actualizar el valor del input oculto
        }        
        

        document.getElementById('id_servicio').addEventListener('change', function() {
            var servicioId = this.value;
            
            fetch('{% url 'obtener_precio_servicio' %}?servicio_id=' + servicioId)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('id_precio').value = data.precio;
                    document.getElementById('id_precio').readOnly = true;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        document.getElementById('id_producto').addEventListener('change', function() {
            var productoId = this.value;
        
            fetch('{% url 'obtener_precio_producto' %}?producto_id=' + productoId)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('Precio').value = data.precio;
                    document.getElementById('Precio').readOnly = true;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
        
        
        
        

    </script>

</body>
</html>
